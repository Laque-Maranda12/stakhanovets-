<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог - Стахановец</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="index.html"><i class="bi bi-tools"></i> Стахано<span>вец</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="index.html">Главная</a></li>
                    <li class="nav-item"><a class="nav-link active" href="catalog.html">Каталог</a></li>
                    <li class="nav-item">
                        <a class="nav-link" href="cart.html">
                            Корзина <span class="badge bg-warning text-dark" id="cart-badge" style="display:none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="repair.html">Ремонт</a></li>
                    <li class="nav-item"><a class="nav-link" href="buyout.html">Выкуп</a></li>
                    <li class="nav-item"><a class="nav-link" href="consultation.html">Консультация</a></li>
                </ul>
                <div id="auth-nav">
                    <a class="btn btn-outline-light btn-sm" href="login.html">Войти</a>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <!-- Page Header -->
        <section class="page-header">
            <div class="container">
                <h1><i class="bi bi-grid-3x3-gap-fill"></i> Каталог инструментов</h1>
            </div>
        </section>

        <div class="container">
            <!-- Category Filter -->
            <div class="mb-4">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <strong class="me-2">Категория:</strong>
                    <div id="category-filters">
                        <button class="btn btn-primary-custom btn-sm active" onclick="filterByCategory(null, this)">Все</button>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="text-center py-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-3 text-muted">Загрузка каталога...</p>
            </div>

            <!-- Tools Grid -->
            <div class="row g-4" id="tools-grid"></div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-5" style="display:none;">
                <i class="bi bi-inbox" style="font-size:3rem; color:#ccc;"></i>
                <p class="mt-3 text-muted">Инструменты не найдены</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <h5><i class="bi bi-tools"></i> Стахановец</h5>
                    <p>Надежный партнер в аренде строительного оборудования с 2010 года.</p>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>Контакты</h5>
                    <p><i class="bi bi-geo-alt"></i> г. Москва, ул. Строителей, 15</p>
                    <p><i class="bi bi-telephone"></i> <a href="tel:+74951234567">+7 (495) 123-45-67</a></p>
                    <p><i class="bi bi-envelope"></i> <a href="mailto:info@stakhanovets.ru">info@stakhanovets.ru</a></p>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>Режим работы</h5>
                    <p><i class="bi bi-clock"></i> Пн-Пт: 8:00-20:00</p>
                    <p><i class="bi bi-clock"></i> Сб: 9:00-18:00</p>
                    <p><i class="bi bi-clock"></i> Вс: выходной</p>
                </div>
            </div>
            <hr style="border-color: rgba(255,255,255,0.2);">
            <p class="text-center mb-0">&copy; 2026 Стахановец. Все права защищены.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        let allTools = [];
        let currentCategory = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadTools();
        });

        async function loadCategories() {
            try {
                const categories = await apiFetch('/api/categories');
                const container = document.getElementById('category-filters');
                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-outline-secondary btn-sm';
                    btn.textContent = cat.name;
                    btn.onclick = function() { filterByCategory(cat.name, this); };
                    container.appendChild(btn);
                });
            } catch (e) {
                console.error('Ошибка загрузки категорий:', e);
            }
        }

        async function loadTools() {
            try {
                allTools = await apiFetch('/api/tools');
                renderTools(allTools);
            } catch (e) {
                console.error('Ошибка загрузки инструментов:', e);
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('empty-state').style.display = 'block';
            }
        }

        function filterByCategory(categoryName, btn) {
            currentCategory = categoryName;
            // Update active button
            document.querySelectorAll('#category-filters button').forEach(b => {
                b.classList.remove('btn-primary-custom', 'active');
                b.classList.add('btn-outline-secondary');
            });
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-primary-custom', 'active');

            if (categoryName === null) {
                renderTools(allTools);
            } else {
                const filtered = allTools.filter(t => t.categoryName === categoryName);
                renderTools(filtered);
            }
        }

        function renderTools(tools) {
            const grid = document.getElementById('tools-grid');
            const spinner = document.getElementById('loading-spinner');
            const empty = document.getElementById('empty-state');

            spinner.style.display = 'none';

            if (tools.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            const cart = getCart();

            grid.innerHTML = tools.map(tool => {
                const isAvailable = tool.status === 'AVAILABLE';
                const inCart = cart.find(t => t.id === tool.id);
                const categoryName = tool.categoryName || 'Без категории';

                return `
                <div class="col-md-6 col-lg-4">
                    <div class="card tool-card">
                        <div class="card-body">
                            <h5 class="card-title">${tool.name}</h5>
                            <p class="text-muted mb-2"><i class="bi bi-tag"></i> ${categoryName}</p>
                            <p class="tool-price mb-1">${tool.pricePerDay} руб/день</p>
                            <p class="text-muted mb-3">Залог: ${tool.deposit} руб.</p>
                            <div class="d-flex justify-content-between align-items-center mt-auto">
                                <span class="badge ${isAvailable ? 'badge-available' : 'badge-unavailable'}">
                                    ${isAvailable ? 'Доступен' : 'Недоступен'}
                                </span>
                                ${isAvailable ? `
                                    <button class="btn ${inCart ? 'btn-success' : 'btn-accent'} btn-sm"
                                            onclick="handleAddToCart(${tool.id})"
                                            ${inCart ? 'disabled' : ''}>
                                        <i class="bi ${inCart ? 'bi-cart-check' : 'bi-cart-plus'}"></i>
                                        ${inCart ? 'В корзине' : 'В корзину'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function handleAddToCart(toolId) {
            const tool = allTools.find(t => t.id === toolId);
            if (tool) {
                addToCart(tool);
                renderTools(currentCategory === null ? allTools : allTools.filter(t => t.categoryName === currentCategory));
            }
        }
    </script>
</body>
</html>
